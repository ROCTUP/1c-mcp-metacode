# Возможности MCP сервера для работы с метаданными 1С

## Обзор

MCP сервер предоставляет три специализированных инструмента для работы с метаданными и кодом конфигураций 1С:Предприятие. 



## Режимы работы MCP-сервера

MCP-сервер может работать в трех режимах, которые управляются через переменные окружения. Это позволяет гибко настраивать его поведение: использовать точные и быстрые шаблонные запросы, мощные возможности LLM для обработки запросов на естественном языке или комбинировать оба подхода.

### 1. Template Mode Only (Только шаблоны)

Это режим **по умолчанию**, который **не требует LLM**. Он предназначен для выполнения точных, заранее определенных операций с графом метаданных через JSON-шаблоны. 

-   **Необходимо указать переменные**:
    -   `TEMPLATE_MODE_ENABLED=true` 
    -   `TEMPLATE_MODE_ONLY=true` 

### 2. LLM Mode Only (Только LLM)

В этом режиме сервер использует OpenAI-совместимую модель для преобразования запросов на естественном языке в точные Cypher-запросы. Шаблонные запросы в этом режиме **отключены**.

-   **Необходимо указать переменные**:
    -   `TEMPLATE_MODE_ENABLED=false`
    -   `TEMPLATE_MODE_ONLY=false`
    -   `OPENAI_API_KEY`: API ключ
    -   `OPENAI_API_BASE`: Адрес API
    -   `OPENAI_MODEL`: Имя модели

### 3. Combined Mode (Комбинированный режим)

Это гибридный режим, в котором **одновременно доступны и шаблонные запросы, и LLM-обработка**. Агент, который обращается к MCP серверу, сам выбирает какой запрос отправлять, шаблонный или на естественном языке. 

-   **Необходимо указать переменные**:
    -   `TEMPLATE_MODE_ENABLED=true` 
    -   `TEMPLATE_MODE_ONLY=false`
    -   `OPENAI_API_KEY`: API ключ
    -   `OPENAI_API_BASE`: Адрес API
    -   `OPENAI_MODEL`: Имя модели


## MCP инструменты и их возможности

### 1. `search_metadata` - Структурный поиск метаданных

**Основное назначение:** Поиск объектов метаданных по их структурным свойствам, связям, техническим характеристикам и отношениям.

**Что можно искать:**
- Объекты метаданных по названию и категории.
- Реквизиты, табличные части, ресурсы, измерения регистров, а также их типы данных и использование в других объектах.
- Формы объектов (основные, списки, выбора) и их роли.
- Команды объектов и форм, их связь с элементами управления формы.
- Макеты печатных форм и их использование.
- Значения перечислений.
- Предопределенные элементы.
- HTTP-сервисы, Шаблоны URL и Методы HTTP-сервисов.
- Журналы документов и их графы.
- Связи между объектами: где конкретный объект используется как тип реквизита, ресурса, измерения, признака учета или признака учета субконто в других объектах метаданных.
- Система прав доступа: какие роли имеют доступ к определенному объекту, к каким объектам имеет доступ конкретная роль, а также детальные права доступа роли с условиями.
- Подписки на события конфигурации: список всех подписок, подписки для конкретного объекта метаданных (с указанием События и Обработчика), а также Источники подписки.
- Обработчики событий форм и привязки элементов управления к командам: структурные связи (метаданные), указывающие, какие процедуры назначены обработчиками событий форм и элементов управления, а также к каким командам привязаны элементы управления формы.
- Элементы управления форм (контролы) и их иерархия, а также привязки данных.
- Поиск объектов метаданных по их уникальным идентификаторам (GUID/UUID/УИД) для таких элементов как основные объекты метаданных, их атрибуты, табличные части, ресурсы, измерения и формы.
- Граф вызовов BSL кода: анализ вызовов процедур/функций в контексте объектов метаданных - "кто вызывает процедуру X модуля объекта Y" (callers) и "что вызывает процедура X" (callees) с поддержкой многоуровневой глубины анализа. Поиск неиспользуемых процедур, экспортируемых методов, вызовов между модулями разных объектов.

**Особенности:**
- Поддержка как естественного языка, так и шаблонных JSON-запросов.
- Более 50 предопределенных операций для различных типов запросов в шаблонном режиме.
- Детальный анализ системы прав доступа с учетом условий.

**Шаблонные операции:**
- Структура объектов: `list_attributes`, `list_tabular_parts`, `list_resources`, `list_dimensions`, `object_structure`
- Связи и зависимости: `find_objects_using_object`, `find_usages_of_object`, `find_documents_making_movements_into_register`
- Формы и интерфейс: `list_forms`, `get_default_forms`, `list_form_controls`, `list_form_events`, `list_form_commands`, `list_form_bindings`, `list_form_attributes`, `list_form_event_handlers`
- Команды и макеты: `list_commands`, `list_layouts`, `find_objects_by_command`, `find_objects_by_layout`
- Типы данных: `get_attribute_type`, `get_tabular_attribute_type`, `list_attributes_with_type`, `get_resource_type`, `get_dimension_type`
- Перечисления и предопределенные: `list_enum_values`, `list_predefined_of_object`, `find_predefined_by_name_in_object`, `find_predefined_by_flag`
- HTTP-сервисы: `list_http_services`, `list_url_templates_of_service`, `list_url_methods_of_template`
- Права доступа: `list_roles_with_access_to_target`, `list_access_targets_of_role`, `get_access_of_role_to_target`
- События: `list_event_subscriptions`, `list_event_subscriptions_of_object`, `get_event_subscription_sources`
- Поиск и навигация: `list_objects_by_category`, `list_objects_by_name`, `resolve_qn`, `find_by_guid`
- Граф вызовов BSL: `list_callees_of_routine`, `list_callers_of_routine`, `call_graph_subtree`, `find_calls_between_owners`, `find_unused_routines`, `list_exported_routines`
- Модули и процедуры: `list_modules_of_owner`, `list_module_routines`, `list_common_module_routines`, `find_routines_by_name`, `find_routines_by_signature`, `list_routine_handled_events`, `list_event_subscription_handlers`

**Примеры использования (естественный язык):**
- "Какие реквизиты у документа Счёт?"
- "Где используется справочник Контрагенты?"
- "Формы справочника Организации"
- "Обработчики событий формы документа Счёт"
- "Какой доступ имеет роль Менеджер к справочнику Контрагенты (с текстом условия)?"
- "Найди элемент по GUID '8f1c2d34-5678-4abc-9def-0123456789ab'"
- "Кто вызывает процедуру ПередЗаписью модуля объекта документа Счёт?"
- "Кого вызывает процедуру ПередЗаписью модуля справочника Контрагенты (глубина 2)?"
- "Привязки команд в форме ФормаЭлемента справочника Контрагенты"
- "Элементы управления формы документа ПриходныйКассовыйОрдер"
- "Предопределенные элементы справочника ВидыДоходов, у которых ТипСчета = 'АктивноПассивный'"

### 2. `search_metadata_by_description` - Семантический поиск по описаниям

**Основное назначение:** Поиск объектов метаданных по их семантическому содержанию, используя описания, комментарии, синонимы и внутренние имена. Инструмент использует полнотекстовый/векторный индекс для поиска по описательным полям.

**Что можно искать:**
- Объекты, соответствующие бизнес-логике или назначению.
- Объекты, функциональные возможности которых включают определенные ключевые слова.
- Объекты по их описаниям, комментариям или справке.
- Объекты по семантически связанным терминам.

**Особенности:**
- Полнотекстовый поиск по полям: `Справка`, `Синоним`, `Комментарий`, `Описание`, `Наименование`.
- Фильтрация по категориям объектов (например, только `Справочники` или `Документы`).
- Специализирован для контентного и семантического поиска, отлично подходит для запросов типа "что хранит", "для чего используется", "про что".

**Шаблонные операции:**
- `search_metadata_by_description` - полнотекстовый поиск по описаниям объектов.

**Примеры использования (естественный язык):**
- "Найди справочники про банковские счета"
- "Документы для поступления товаров"
- "Объекты, где упоминается IBAN"
- "Регистры сведений, содержащие информацию о контрагентах"
- "Перечисления, связанные с видами доходов"

### 3. `search_code` - Поиск и получение BSL кода

**Основное назначение:** Семантический поиск процедур и функций по их описаниям и получение исходного кода BSL.

**Что можно искать:**
- Процедуры и функции по их описаниям (комментарии, которые расположены перед процедурой/функцией).
- Исходный код процедур и функций с полной документацией, директивами компиляции, путем к файлу и номером строки.
- Методы из различных типов модулей (модули объектов, модули менеджеров, модули форм, общие модули, модули команд).
- Процедуры и функции из БСП (Библиотека стандартных подсистем) с автоматическим определением по контексту.
- Экспортные/неэкспортные методы, методы с определенными директивами (&НаСервере, &НаКлиенте и т.д.).

**Особенности:**
- Полнотекстовый/гибридный поиск по описанию из комментариев к процедуре/функции.
- Получение исходного кода с контекстом: файл, строка, владелец (объект/форма/общий модуль).
- Справка по БСП: упоминание "БСП", "SSL", "библиотека стандартных подсистем" автоматически фильтрует результаты только по процедурам и функциям из области ПрограммныйИнтерфейс БСП.
- Фильтры: по типу процедуры/функции, по экспортности, по директиве, по владельцу (объект метаданных).

**Шаблонные операции:**
- `find_routines_by_description` - полнотекстовый/гибридный поиск процедур/функций по описанию
- `get_routine_body` - получение исходного кода по ID, имени+владельцу или сигнатуре

**Примеры использования (естественный язык):**
- "Найди функции для работы с XML"
- "Процедуры для печати счетов"
- "Функции из БСП для работы с файлами"
- "Покажи тело процедуры ПередЗаписью из документа Счёт"
- "Исходный код функции ПолучитьЗначениеРеквизита из БСП"
- "Процедуры на сервере для обработки email"
- "Функции общего модуля СтроковыеФункцииКлиентСервер для работы с JSON"

**Примечание:** Для анализа графа вызовов, поиска неиспользуемых процедур, анализа обработчиков событий используйте инструмент `search_metadata`, который предоставляет структурный анализ кода в контексте объектов метаданных.

---

## Разделение ответственности между инструментами

### Когда использовать `search_metadata`:
- **Структурные запросы**: "Какие реквизиты у документа X?", "Где используется справочник Y?"
- **Связи объектов**: "Какие документы делают движения в регистр Z?", "Что использует тип данных X?"
- **Права доступа**: "Какие роли имеют доступ к объекту X?", "К чему имеет доступ роль Y?"
- **Формы и интерфейс**: "Какие формы есть у объекта X?", "Элементы управления формы Y"
- **Граф вызовов в контексте метаданных**: "Кто вызывает ПередЗаписью документа Счёт?", "Граф вызовов модуля справочника X"
- **Обработчики событий**: "Обработчики формы X", "Процедуры-обработчики подписок на события"
- **Поиск по GUID**: "Найди объект по GUID xyz"

### Когда использовать `search_metadata_by_description`:
- **Семантический поиск объектов**: "Найди справочники про банковские счета"
- **Поиск по назначению**: "Документы для учета зарплаты"
- **Поиск по ключевым словам**: "Объекты, где упоминается IBAN"
- **Общие концепции**: "Что хранит информацию о контрагентах?"

### Когда использовать `search_code`:
- **Семантический поиск процедур/функций**: "Найди процедуры для работы с XML"
- **Поиск кода по описанию**: "Функции для печати счетов"
- **Получение исходного кода**: "Покажи тело процедуры ПередЗаписью из документа Счёт"
- **Поиск в БСП**: "Функции из библиотеки стандартных подсистем для работы с файлами"
- **Фильтрация по характеристикам**: "Экспортные функции на сервере для обработки email"

### Ключевые различия:

| Аспект | search_metadata | search_code |
|--------|----------------|-------------|
| **Основной фокус** | Структура метаданных и связи | Содержание и исходный код BSL |
| **Тип поиска** | Структурный + граф связей | Семантический (fulltext/hybrid по описаниям) |
| **Возвращает** | Метаданные, связи, структуры | Описания процедур + исходный код |
| **Граф вызовов** | ✅ Да (в контексте объектов) | ❌ Нет (используйте search_metadata) |
| **Исходный код** | ❌ Нет (только ID процедур) | ✅ Да (полный код с контекстом) |
| **Поиск по описанию процедур** | ❌ Нет | ✅ Да (fulltext/hybrid по doc_description) |
| **Структура объектов** | ✅ Да (реквизиты, формы, команды) | ❌ Нет |

### Типичные сценарии комбинированного использования:

1. **Найти и просмотреть код процедуры:**
   - `search_metadata`: "Обработчики события ПередЗаписью документа Счёт" → получаем routine_id
   - `search_code`: "Покажи тело процедуры с ID xyz" → получаем исходный код

2. **Анализ использования объекта в коде:**
   - `search_metadata`: "Где используется справочник Контрагенты?" → структурные связи
   - `search_metadata`: "Граф вызовов процедур, работающих с Контрагентами" → анализ кода

3. **Поиск функциональности:**
   - `search_code`: "Функции для формирования XML" → список процедур с описаниями
   - `search_code`: "Покажи код функции X" → исходный код для анализа


## Режимы поиска  по описаниям

MCP-сервер поддерживает два основных режима поиска для описаний процедур/функций и метаданных:

### 1. Полнотекстовый поиск (Fulltext-only Search)

Это режим **по умолчанию**, который используется, когда векторные представления (embeddings) для соответствующих сущностей отключены. В этом режиме поиск производится исключительно по текстовым данным с использованием полнотекстовых индексов.

-   **Когда активируется:**
    -   Если `EMBEDDING_API_BASE` не настроен.
    -   Если `ENABLE_ROUTINE_DESCRIPTION_EMBEDDING=false` для поиска по описаниям процедур/функций.
    -   Если `ENABLE_METADATA_DESCRIPTION_EMBEDDING=false` для поиска по описаниям метаданных.

### 2. Гибридный поиск (Hybrid Search)

Этот режим объединяет возможности полнотекстового и векторного поиска для достижения более релевантных результатов, учитывая как точные совпадения по ключевым словам, так и семантическую близость. Он активируется, когда включена генерация векторных представлений (embeddings) для соответствующих сущностей.

-   **Как работает:**
    -   Производится два независимых поиска: один полнотекстовый (по ключевым словам) и один векторный (по смыслу).
    -   Результаты из обоих поисков объединяются. При этом система временно запрашивает больше кандидатов, чем нужно, чтобы потом выбрать лучшие.   
    -   Оценки релевантности (scores) от полнотекстового и векторного поиска объединяются с помощью взвешенной суммы или специализированных алгоритмов, таких как Reciprocal Rank Fusion (RRF), чтобы сформировать единый "гибридный" рейтинг. Это позволяет учитывать вклад обеих компонент.
    -   Лучшие результаты из объединенного и отсортированного списка возвращаются MCP сервером.

-  **Необходимо указать переменные:**
    -   `EMBEDDING_API_BASE`: API адрес сервиса embeddings
    -   `EMBEDDING_API_KEY`: API ключ сервиса embeddings
    -   `EMBEDDING_MODEL`: Имя модели для embeddings    
	-   `ENABLE_ROUTINE_DESCRIPTION_EMBEDDING=true`: Включает векторную индексацию и гибридный поиск для описаний процедур/функций.
    -   `ENABLE_METADATA_DESCRIPTION_EMBEDDING=true`: Включает векторную индексацию и гибридный поиск для описаний объектов метаданных.

  
